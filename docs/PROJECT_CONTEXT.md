# 景氣週期投資策略系統 - 專案說明文件

> **本文件為本地語言模型專用，提供完整的專案上下文資訊**
> 
> **最後更新時間**：2026-01-27
> 
> **自動更新機制**：當專案關鍵檔案變更時，本文件會自動更新
>
> **中英簡介與資料庫筆數統計**：見 [README](README.md#overview) 與 [README 中文簡介](README.md#中文簡介)

---

## 開發緣起

台灣景氣對策信號（景氣燈號）為國發會每月發布的綜合指標，實務上常被用來輔助判斷景氣階段與資產配置時機。參考 TEJ 台灣經濟新報等文獻（如「從景氣燈號到資產輪動：一套避開熊市的量化策略」）所提出的景氣循環投資邏輯，本專案旨在**實作並可回測**該類策略，並擴充至多種資產配置與濾網（如 M1B、VIX）。

投資人與研究者需要一套**可重現、可驗證**的量化回測環境，整合景氣指標、股價、融資融券、VIX 等資料，並支援傳統規則策略與 Orange 機器學習策略的比較。本系統即為此而建：從景氣與總經匯入、市場與技術資料蒐集、到多策略回測與 Orange 一鍵 Pipeline，提供完整資料管線與回測驗證。

---

## 主要功能

- **景氣與總經資料**：讀取景氣燈號與指標（主選單選項 1）、一鍵匯入多張景氣表、M1B 年增率與合併總經指標計算與儲存。
- **股價與市場資料**：上市／上櫃股價蒐集與批次更新（選項 2、5）、融資融券數據蒐集與衍生指標（選項 13）。
- **VIX 資料**：下載當月缺失日、解析寫入 TFE_VIX_data、重算 VIX 月K線與更新 VIX_data（選項 14）；VIX 衍生指標計算並寫入 VIX_data（選項 15）。
- **技術與分析**：技術指標計算日線／月線（選項 17）；建立中文別名 VIEW（選項 16）。
- **回測與輸出**：新系統回測（選項 12，基於 Orange 資料與多策略）、績效報告與圖表（選項 4）、回測驗證檢查。
- **Orange 整合**：輸出 Orange 分析數據（選項 11）、Orange 一鍵 Pipeline 蒐集→衍生→匯出（選項 18）。
- **資料品質**：股價驗證與修正（選項 6–9）、專案說明文件自動更新（選項 10）。

---

## 產品特色

- **景氣燈號與發布延遲**：嚴謹實作 N+1 月 27 日發布邏輯，月資料轉交易日、信號可交易日均依此處理，避免前視偏差。
- **分批執行與第 6 天檢查**：買進／賣出皆 5 日分批執行，金額／數量依初始投資組合或持倉計算；第 6 天檢查剩餘現金是否可再買一張，邏輯在 `backtesting/backtest_engine_new.py` 實作並可驗證。
- **多策略架構**：16+ 種策略（基本、等比例、動態倉位、M1B 濾網、倍數放大等），加上 Orange 預測策略，便於比較不同風險偏好與濾網效果。
- **交易成本與驗證**：手續費 0.1425%、證交稅 0.3%，回測過程可記錄信號／訂單／持倉快照並由 `backtesting/backtest_validator.py` 驗證。
- **資料管線完整**：從景氣 CSV、證交所／櫃買／期交所 API 到 SQLite 儲存，含融資融券、VIX 日內→月K→衍生指標，以及 Orange 匯出與一鍵 Pipeline。
- **在地化**：台灣交易日曆（pandas_market_calendars）、證交所／櫃買／期交所資料源、M1B／景氣指標等皆以台灣市場為準。

---

## 分析結果

- **回測區間與標的**：例如 2020 年至今、主標的 006208（富邦台 50）、避險資產如 00865B／00687B／現金等；初始資金與分批規則見回測章節。
- **策略表現摘要**：回測結果示例（年化報酬、夏普、最大回撤）見 [README](README.md) 策略表現表；Orange 模型、短天期美債、買進持有、現金避險等之相對位置可供策略選擇參考。
- **驗證與輸出**：回測驗證項目包含信號時機、訂單執行、持倉變化、M1B 濾網；Excel／圖表輸出含持倉、現金、報酬率、交易記錄等。
- **資料庫規模**：各表筆數與區間見 [results/資料庫筆數統計.txt](../results/資料庫筆數統計.txt) 或 README 中文簡介；總筆數約 1,115 萬筆，覆蓋上市/上櫃股價、景氣、VIX、融資融券、技術指標、回測結果等。

---

## 未來發展

- **策略與標的**：更多標的組合、其他景氣或總經濾網、參數優化或穩健性測試。
- **資料與指標**：更多總經／技術指標、其他交易所或頻率（如週頻）、VIX 以外波動率指標。
- **回測與驗證**：更多驗證項目、敏感性分析、與實盤或紙上交易對接之可能性（僅概念性）。
- **文件與維護**：專案說明文件與 README 隨選單／模組變更持續更新（含 `scripts/update_project_context.py` 之運用）。

---

## 專案概述

### 專案目的

本專案實作基於台灣景氣對策信號（景氣燈號）的量化投資策略回測系統。系統透過分析景氣週期的不同階段，自動調整股票與避險資產的配置比例，以達到在景氣循環中獲利並控制風險的目標。詳細功能與特色見上方「主要功能」「產品特色」。

### 技術架構

- **語言**：Python 3.x
- **主要套件**：pandas, numpy, pandas_market_calendars
- **資料庫**：SQLite（儲存股價和景氣資料）
- **資料來源**：證交所API、政府開放資料（CSV）

---

## 系統架構

### 模組結構

```
Business_Cycle_stratgy/
├── data_collection/          # 資料蒐集模組
│   ├── cycle_data_collector.py       # 景氣燈號資料讀取（從CSV，月轉日）
│   ├── stock_data_collector.py      # 股票和ETF資料蒐集（證交所API）
│   ├── otc_data_collector.py        # 上櫃股票資料蒐集
│   ├── indicator_data_collector.py # 景氣指標資料蒐集與合併總經指標
│   ├── m1b_calculator.py            # M1B年增率和動能計算
│   ├── margin_data_collector.py     # 融資融券資料蒐集（證交所API）
│   ├── vix_derivatives.py           # VIX 衍生指標計算並寫入 VIX_data
│   ├── technical_indicator_calculator.py  # 技術指標計算（日線/月線）
│   └── database_manager.py          # 資料庫管理
├── backtesting/              # 回測模組
│   ├── backtest_engine_new.py    # 新版回測引擎（支援分批執行和第6天檢查）
│   ├── backtest_engine.py        # 舊版回測引擎
│   ├── strategy.py               # 策略邏輯實作（16種策略）
│   ├── strategy_tej.py            # 景氣燈號策略（TEJ）
│   ├── strategy_orange.py         # Orange 機器學習預測策略
│   ├── orange_model_loader.py     # Orange 模型載入
│   ├── chart_generator.py         # 績效圖表生成
│   └── backtest_validator.py      # 回測驗證檢查模組
├── data_validation/          # 資料驗證模組
│   └── price_validator.py       # 股價資料驗證與修正
├── utils/                    # 工具模組
│   └── timestamp_converter.py   # 時間戳轉換（資料庫日期格式標準化）
├── VIX_dictionary_put_in_database/  # VIX 資料處理（下載、解析、月K線）
│   ├── parse_tvix_to_json.py      # 解析 VIX 原始 TXT 為 JSON
│   ├── batch_parse_tvix_folder.py # 批次解析 VIX TXT 資料夾
│   ├── put_VIXdata_in_to_database.py  # 寫入 TFE_VIX_data
│   ├── calculate_tvix_to_mouth_k_line.py  # 計算 VIX 月K線
│   └── normalize_vix_date_format.py      # VIX_data 日期格式標準化
├── orange_data_export/       # Orange 資料匯出與模型
│   ├── export_for_prediction.py  # 匯出預測用資料
│   └── inspect_model.py          # 模型檢查
├── scripts/                  # 腳本
│   ├── export_orange_data.py     # 輸出 Orange 分析數據
│   ├── run_orange_pipeline.py    # Orange 一鍵 Pipeline
│   └── update_project_context.py # 更新本文件
├── business_cycle/           # 景氣燈號資料（CSV檔案）
├── docs/                     # 文件資料夾
│   ├── STRATEGY_EXPLANATION.md   # 策略詳細說明
│   └── PROJECT_CONTEXT.md        # 本文件
└── main.py                   # 主執行檔（選單 0-18）
```

### 資料流

1. **資料準備階段**：
   - 讀取景氣燈號CSV → `CycleDataCollector` → 轉換為交易日資料 → 存入資料庫
   - 從證交所API取得股價資料 → `StockDataCollector` → 存入資料庫
   - 計算M1B指標 → `M1BCalculator` → 存入資料庫

2. **回測執行階段**：
   - 從資料庫讀取資料 → `BacktestEngineNew.run_backtest()` → 逐日迭代
   - 每日：取得景氣燈號 → 策略產生訂單 → 執行交易 → 計算持倉價值
   - 分批執行：5天分批買賣 + 第6天檢查剩餘現金
   - 驗證檢查：記錄信號、訂單、持倉快照 → 回測結束後驗證

3. **結果輸出階段**：
   - 計算績效指標 → 輸出Excel檔案（包含持倉、現金部位、平均成本） → 生成驗證報告

---

## 關鍵類別和函數

### BacktestEngineNew（回測引擎）

**檔案**：`backtesting/backtest_engine_new.py`

**主要職責**：
- 管理回測狀態（現金、持倉、交易記錄）
- 逐日迭代執行回測
- 處理分批執行邏輯（5天 + 第6天檢查）
- 計算績效指標
- 記錄每日現金餘額和持倉平均成本

**關鍵方法**：
- `run_backtest(start_date, end_date, strategy_func, price_data, cycle_data, m1b_data)`: 執行回測主流程
- `_execute_order(order, date, price_dict)`: 執行單筆訂單（買進或賣出，支援分批執行和第6天檢查）
- `_calculate_portfolio_value(date, price_dict)`: 計算投資組合總價值
- `_calculate_metrics()`: 計算績效指標（報酬率、夏普比率等）

**重要狀態變數**：
- `self.cash`: 當前現金餘額
- `self.positions`: 當前持倉 {ticker: shares}
- `self.trades`: 所有交易記錄
- `self.daily_cash`: 每日現金餘額列表（用於Excel輸出）
- `self.daily_positions`: 每日持倉快照列表

**重要特性**：
- 支援5天分批執行 + 第6天檢查剩餘現金
- 買進金額基於初始投資組合價值計算，確保5天平均分配
- 賣出數量基於初始持倉數量計算，確保5天平均分配
- 現金不足買一張時保留作為預備金

### CycleStrategy（策略基類）

**檔案**：`backtesting/strategy.py`

**主要職責**：
- 定義策略介面
- 提供基本策略邏輯（藍燈買進、紅燈賣出）

**關鍵方法**：
- `generate_orders(state, date, price_dict, positions, portfolio_value)`: 根據策略狀態產生訂單

**策略狀態字典（state）**：
```python
{
    'state': bool,              # 是否持有股票
    'hedge_state': bool,        # 是否持有避險資產
    'score': float,             # 當前景氣燈號分數
    'prev_score': float,        # 上月景氣分數
    'score_momentum': float,     # 景氣分數動能（當前-上月）
    'm1b_yoy_month': float,     # M1B年增率
    'm1b_yoy_momentum': float,  # M1B年增率動能
    'm1b_mom': float,          # M1B月對月變化率
    'm1b_vs_3m_avg': float,    # M1B vs 前三個月平均
    'should_buy_in_split': bool, # 是否在分批買進時間窗口
    'should_sell_in_split': bool # 是否在分批賣出時間窗口
}
```

### CycleDataCollector（景氣資料收集器）

**檔案**：`data_collection/cycle_data_collector.py`

**主要職責**：
- 從CSV讀取景氣燈號月資料
- 轉換為交易日資料
- 處理發布日期邏輯（N+1月27日）

**關鍵方法**：
- `load_cycle_data_from_csv()`: 讀取CSV檔案
- `convert_monthly_to_daily(start_date, end_date)`: 轉換為交易日資料

**重要邏輯**：
- N月的景氣燈號在N+1月的27日發布
- 每個交易日使用前一個月的燈號分數（反映發布延遲）

### M1BCalculator（M1B計算器）

**檔案**：`data_collection/m1b_calculator.py`

**主要職責**：
- 計算M1B年增率（當前月份 vs 去年同月份）
- 計算M1B年增率動能（當前年增率 - 上月年增率）
- 計算M1B月對月變化率
- 計算M1B vs 前三個月平均

**關鍵方法**：
- `calculate_yoy_month(df)`: 計算年增率
- `calculate_yoy_momentum(df)`: 計算年增率動能
- `calculate_mom(df)`: 計算月對月變化率
- `calculate_vs_3m_avg(df)`: 計算vs前三個月平均

### BacktestValidator（驗證檢查器）

**檔案**：`backtesting/backtest_validator.py`

**主要職責**：
- 記錄回測過程中的信號、訂單、持倉快照
- 驗證信號時機是否正確
- 驗證訂單執行是否完整
- 驗證持倉變化是否符合策略邏輯
- 生成驗證報告

**關鍵方法**：
- `record_signal(signal_type, date, score, publish_date, ...)`: 記錄信號事件
- `record_order(date, action, ticker, percent, ...)`: 記錄訂單事件
- `record_position_snapshot(date, positions, portfolio_value)`: 記錄持倉快照
- `validate_signal_timing(trading_days, cycle_data)`: 驗證信號時機
- `validate_order_execution()`: 驗證訂單執行
- `generate_report()`: 生成驗證報告

---

## 策略邏輯詳解

### 景氣燈號分數範圍（官方標準）

根據國發會標準：
- **藍燈**：9-16分（景氣低迷）
- **黃藍燈**：17-22分（景氣趨緩）
- **綠燈**：23-31分（景氣穩定）
- **黃紅燈**：32-37分（景氣趨熱）
- **紅燈**：38-45分（景氣過熱）

### 時間延遲機制

**資料發布邏輯**：
- N月的景氣燈號在N+1月的27日發布
- 系統使用發布日期來判斷何時可以交易

**交易執行邏輯**：
- **買進信號**：當偵測到從非藍燈變成藍燈時，在發布日期後的5個交易日分批買進，並在第6天檢查剩餘現金
- **賣出信號**：當偵測到從非紅燈變成紅燈時，在隔月的最後5個交易日分批賣出，並在第6天檢查剩餘現金

### 分批執行邏輯

所有買賣訂單都會分成5天執行，並在第6天檢查剩餘現金，以降低市場衝擊並充分利用資金：
- **買進**：從發布日期開始，連續5個交易日分批買進（每天約20%，基於初始投資組合價值計算）
- **賣出**：從隔月最後5個交易日開始，分批賣出（每天約20%，基於初始持倉數量計算）
- **第6天檢查**：檢查剩餘現金是否足夠買一張（1000股），如果足夠則自動買進
- **金額計算**：
  - 買進：每天金額基於**初始投資組合價值**計算，確保5天平均分配
  - 賣出：每天數量基於**初始持倉數量**計算，確保5天平均分配
  - 第5天（最後一天）會使用所有可用現金/持倉，確保完全執行

### 策略分類

#### 1. 基本策略（策略0-4）

**邏輯**：
- 藍燈（9-16分）：買進100%股票，賣出避險資產
- 紅燈（≥38分）：賣出100%股票，買進避險資產
- 其他燈號：首次進入時買進100%股票

**變體**：
- `ShortTermBondStrategy`: 避險資產為00865B（短天期美債）
- `CashStrategy`: 避險資產為現金
- `LongTermBondStrategy`: 避險資產為00687B（長天期美債）
- `InverseETFStrategy`: 避險資產為00664R（0050反向ETF）

#### 2. 等比例配置策略（策略5-7）

**邏輯**：
- 根據燈號等級維持固定比例配置
- 例如：`FiftyFiftyStrategy` 在紅燈時保留50%股票、50%避險資產

**變體**：
- `FiftyFiftyStrategy`: 50:50配置
- `ProportionalAllocationStrategy`: 等比例配置（根據燈號調整比例）
- `TSMCProportionalAllocationStrategy`: 台積電等比例配置

#### 3. M1B濾網策略（策略8-10）

**邏輯**：
- 在基本策略基礎上，加入M1B動能濾網
- 當M1B動能 < 0 時（價量背離），觸發特殊處理：
  - `M1BFilterCash`: 清倉股票，持有現金
  - `M1BFilterBond`: 清倉股票，買進債券
  - `M1BFilterProportional`: 清倉股票，全部投入債券

**M1B指標**：
- `m1b_yoy_month`: M1B年增率（當前月份 vs 去年同月份）
- `m1b_yoy_momentum`: M1B年增率動能（當前年增率 - 上月年增率）
- `m1b_mom`: M1B月對月變化率
- `m1b_vs_3m_avg`: M1B vs 前三個月平均

#### 4. 動態倉位策略（策略11-13）

**邏輯**：
- 根據燈號等級和動能指標動態調整倉位
- 藍燈（9-16分）：100%倉位
- 黃藍燈（17-22分）：根據動能調整（動能< -2時50%，否則100%）
- 綠燈（23-31分）：根據動能調整（動能< -2時50%，否則100%）
- 黃紅燈（32-37分）：根據M1B動能調整（動能< 0時清倉，否則50%）
- 紅燈（≥38分）：根據M1B動能調整（動能< 0時清倉，否則50%）

**變體**：
- `DynamicPositionCashStrategy`: 動態倉位+現金避險
- `DynamicPositionBondStrategy`: 動態倉位+短債避險
- `DynamicPositionProportionalStrategy`: 動態倉位+等比例配置

#### 5. 倍數放大策略（策略14-15）

**邏輯**：
- 根據燈號等級遞減倉位
- 藍燈（9-16分）：100%股票，0%債券
- 黃藍燈（17-22分）：75%股票，25%債券
- 綠燈（23-31分）：50%股票，50%債券
- 黃紅燈（32-37分）：25%股票，75%債券
- 紅燈（≥38分）：0%股票，100%債券

**變體**：
- `MultiplierAllocationCashStrategy`: 倍數放大+現金避險
- `MultiplierAllocationBondStrategy`: 倍數放大+短債避險

---

## 資料處理流程

### 景氣燈號資料處理

**資料來源**：`business_cycle/景氣指標與燈號.csv`

**處理流程**：
1. 讀取CSV檔案（月資料，YYYYMM格式）
2. 提取欄位：Date, 景氣對策信號綜合分數, 景氣對策信號
3. 轉換為交易日資料：
   - 使用 `pandas_market_calendars` 取得交易日曆
   - 每個交易日使用該月的景氣分數
   - 計算發布日期：N+1月27日
   - 記錄資料年月（data_year, data_month）

**重要欄位**：
- `date`: 交易日日期
- `score`: 景氣對策信號綜合分數
- `publish_date`: 發布日期（N+1月27日）
- `data_year`: 資料年份
- `data_month`: 資料月份

### M1B資料處理

**資料來源**：資料庫中的 `tw_price_indices_data` 表

**處理流程**：
1. 從資料庫讀取M1B貨幣總計數資料
2. 計算各項指標：
   - 年增率：當前月份 vs 去年同月份
   - 年增率動能：當前年增率 - 上月年增率
   - 月對月變化率：(當月M1B - 上月M1B) / 上月M1B * 100
   - vs前三個月平均：當前M1B / 前三個月平均M1B
3. 轉換為交易日資料（每個交易日使用該月的M1B值）

**發布邏輯**：
- M1B資料同樣遵循N+1月27日發布的邏輯
- 系統會自動處理發布延遲

### 股價資料處理

**資料來源**：證交所API（`MI_INDEX`）

**處理流程**：
1. 從API取得每日收盤行情
2. 存入SQLite資料庫（`tw_stock_price_data` 表）
3. 回測時從資料庫讀取

**重要欄位**：
- `date`: 交易日期（YYYYMMDD格式）
- `ticker`: 標的代號
- `close`: 收盤價

---

## 回測引擎邏輯

### 回測流程

1. **初始化**：
   - 設定初始資金（預設100,000元）
   - 初始化持倉、現金、交易記錄

2. **逐日迭代**：
   - 取得當日景氣燈號資料
   - 檢測燈號變化（從非藍燈→藍燈，從非紅燈→紅燈）
   - 更新策略狀態（分數、動能、M1B指標等）
   - 策略產生訂單
   - 處理分批執行邏輯
   - 執行訂單
   - 計算投資組合價值
   - 記錄持倉快照（用於驗證）

3. **計算績效指標**：
   - 總報酬率
   - 年化報酬率
   - 夏普比率
   - 最大回落
   - 勝率
   - 平均持倉期間

### 交易成本計算

**手續費**：
- 費率：0.1425%
- 最低：20元
- 適用於買進和賣出

**證交稅**：
- 費率：0.3%
- 僅適用於賣出

**計算公式**：
```python
commission = max(value * 0.001425, 20)  # 手續費
tax = value * 0.003 if action == 'sell' else 0  # 證交稅（僅賣出）
```

### 分批執行邏輯

**買進分批**：
- 觸發條件：藍燈發布後
- 執行時間：發布日期後的5個交易日 + 第6天檢查剩餘現金
- 執行方式：每天執行約20%（基於初始投資組合價值），第5天使用所有可用現金
- **第6天檢查**：如果剩餘現金足夠買一張（1000股），自動買進

**賣出分批**：
- 觸發條件：紅燈發布後
- 執行時間：隔月的最後5個交易日 + 第6天檢查剩餘現金
- 執行方式：每天執行約20%（基於初始持倉數量），第5天賣出所有剩餘持倉
- **第6天檢查**：如果剩餘現金足夠買一張避險資產（1000股），自動買進
- 特殊處理：如當月交易日不足5天，會延伸到次月

**現金管理**：
- 最小交易單位：1000股（一張）
- 如果現金不足買一張，會保留現金作為預備金，不執行買進
- 第6天會檢查剩餘現金，如果足夠買一張則自動買進

**同步買進避險資產**：
- 當股票賣出時，如果策略有避險資產，會同步買進
- 避險資產的買進也會分批執行，與股票賣出同步
- 第6天也會檢查避險資產的買進機會

---

## 驗證檢查系統

### 驗證項目

1. **信號時機驗證**：
   - 檢查買進信號是否在發布日期後的5個交易日內執行
   - 檢查賣出信號是否在隔月最後5個交易日內執行

2. **訂單執行驗證**：
   - 檢查分批買賣是否完整（5天是否都執行）
   - 檢查避險資產是否與股票同步買賣
   - 檢查訂單總比例是否接近100%

3. **持倉變化驗證**：
   - 檢查動態倉位策略的目標比例是否正確
   - 檢查等比例配置策略的配置是否正確

4. **M1B濾網驗證**：
   - 檢查價量背離時是否正確清倉或轉換
   - 檢查M1B動能計算是否正確

### 驗證報告

驗證報告包含：
- 總違規項目數
- 錯誤列表（嚴重問題）
- 警告列表（潛在問題）
- 信號事件統計
- 訂單事件統計
- 持倉快照統計

---

## Excel輸出格式

### 持倉欄位

**顯示格式**：`ticker:shares@avg_cost`

**範例**：`006208:2000@25.50` 表示持有006208共2000股，平均成本25.50元

**說明**：
- 包含股票代號、持倉股數和平均成本
- 多個持倉以分號分隔（例如：`006208:2000@25.50;00865B:1000@32.10`）
- 平均成本使用加權平均法計算：(舊總成本 + 新成本) / (舊股數 + 新股數)

### 現金部位欄位

**功能**：顯示每日現金餘額

**用途**：
- 追蹤現金使用情況
- 確認現金是否充分利用
- 檢查第6天檢查是否正確執行

### 其他欄位

- **日期**：交易日日期
- **投資組合價值**：當日投資組合總價值（現金 + 持倉市值）
- **每日報酬率(%)**：當日報酬率
- **累積報酬率(%)**：從開始到當日的累積報酬率
- **動作**：當日執行的交易動作（買進/賣出）
- **總交易量(價格)**：當日交易總金額
- **盈虧**：當日實現損益
- **稅費**：當日手續費和證交稅

---

## 關鍵檔案說明

### main.py

**功能**：主執行檔，提供互動式選單（選項 0-18）

**選單一覽**：

| 選項 | 功能 |
|------|------|
| 1 | 讀取景氣燈號與指標資料（從 CSV，可一鍵匯入所有景氣指標） |
| 2 | 蒐集股票和ETF資料（含禮貌休息） |
| 3 | 執行回測（2020年至今）[已捨棄] |
| 4 | 產生績效報告和圖表 |
| 5 | 批次更新資料（含禮貌休息） |
| 6 | 驗證股價資料（檢查異常） |
| 7 | 檢查資料完整性（檢查交易日是否有指定股票資料） |
| 8 | 填補零值價格資料（處理沒有交易的日子） |
| 9 | 刪除上櫃資料表中的權證資料（7開頭六位數） |
| 10 | 更新專案說明文件（自動檢測變更並更新） |
| 11 | 輸出 Orange 分析數據（股價 + 指標數據） |
| 12 | 執行回測（新系統，基於 Orange 資料） |
| 13 | 收集融資融券數據（2015-2025年，含衍生指標） |
| 14 | 下載並重新計算 VIX 月K線（自動偵測當月缺失日期） |
| 15 | 計算 VIX 衍生指標（寫入 VIX_data 表） |
| 16 | 建立中文別名 VIEW（為所有資料表建立中文欄位名稱視圖） |
| 17 | 計算技術指標（日線/月線） |
| 18 | Orange 一鍵 Pipeline（蒐集→衍生→匯出） |
| 0 | 離開 |

### backtesting/backtest_engine_new.py

**功能**：回測引擎核心邏輯（新版）

**關鍵類別**：`BacktestEngineNew`

**重要方法**：
- `run_backtest()`: 執行回測主流程
- `_execute_order()`: 執行單筆訂單（支援分批執行和第6天檢查）
- `_calculate_portfolio_value()`: 計算投資組合價值
- `_calculate_metrics()`: 計算績效指標

**重要特性**：
- 支援5天分批執行 + 第6天檢查剩餘現金
- 記錄每日現金餘額（`daily_cash`）
- 記錄每日持倉快照（`daily_positions`）
- 基於初始投資組合價值/初始持倉計算分批金額

### backtesting/strategy.py

**功能**：策略邏輯實作

**關鍵類別**：
- `CycleStrategy`: 策略基類
- 16種策略子類別

**重要方法**：
- `generate_orders()`: 根據策略狀態產生訂單

### data_collection/cycle_data_collector.py

**功能**：景氣燈號資料處理

**關鍵類別**：`CycleDataCollector`

**重要方法**：
- `load_cycle_data_from_csv()`: 讀取CSV檔案
- `convert_monthly_to_daily()`: 轉換為交易日資料

### data_collection/m1b_calculator.py

**功能**：M1B指標計算

**關鍵類別**：`M1BCalculator`

**重要方法**：
- `calculate_yoy_month()`: 計算年增率
- `calculate_yoy_momentum()`: 計算年增率動能
- `calculate_mom()`: 計算月對月變化率
- `calculate_vs_3m_avg()`: 計算vs前三個月平均

### backtesting/backtest_validator.py

**功能**：回測驗證檢查

**關鍵類別**：`BacktestValidator`

**重要方法**：
- `record_signal()`: 記錄信號事件
- `record_order()`: 記錄訂單事件
- `record_position_snapshot()`: 記錄持倉快照
- `validate_signal_timing()`: 驗證信號時機
- `validate_order_execution()`: 驗證訂單執行
- `generate_report()`: 生成驗證報告

---

## 常見問題和注意事項

### 已知限制

1. **資料完整性**：
   - 某些ETF可能在回測期間尚未上市，系統會自動跳過缺少價格的訂單
   - 景氣燈號資料可能有缺失月份，系統會使用前一個有效日期的資料

2. **交易成本簡化**：
   - 系統假設所有交易都能以收盤價成交
   - 未考慮滑價（slippage）和市場衝擊

3. **分批執行**：
   - 分批執行邏輯：5天正常執行 + 第6天檢查剩餘現金
   - 買進金額基於初始投資組合價值計算，確保5天平均分配
   - 賣出數量基於初始持倉數量計算，確保5天平均分配
   - 第5天使用所有可用現金/持倉，確保完全執行
   - 第6天檢查剩餘現金，如果足夠買一張則自動買進

### 重要假設

1. **發布延遲**：
   - 系統假設N月的景氣燈號在N+1月的27日發布
   - 交易執行基於發布日期，而非資料月份

2. **交易日曆**：
   - 使用 `pandas_market_calendars` 的台灣交易日曆（XTAI）
   - 自動處理假日和特殊休市日（如颱風假）

3. **最小交易單位**：
   - 系統以千股為單位進行交易（符合台灣市場）
   - 如果計算出的股數不足1000股，會向下取整

4. **現金管理**：
   - 最小交易單位：1000股（一張）
   - 如果現金不足買一張，會保留現金作為預備金，不執行買進
   - 第6天會檢查剩餘現金，如果足夠買一張則自動買進
   - 不會產生負現金或負持倉

### 資料庫結構

**主要資料表**：
- `tw_stock_price_data`: 上市股票和ETF每日股價資料
- `tw_otc_stock_price_data`: 上櫃股票每日股價資料
- `tw_price_indices_data`: 價格指數資料（包含M1B）
- `business_cycle_data`: 景氣燈號每日資料
- `market_margin_data`: 大盤融資融券與衍生指標（選項 13 寫入）
- `TFE_VIX_data`: 期交所 VIX 日內原始資料（選項 14 下載解析後寫入）
- `VIX_data`: VIX 月K線與衍生指標（選項 14 寫入月K、選項 15 寫入衍生欄位）

各表筆數與區間見 [results/資料庫筆數統計.txt](../results/資料庫筆數統計.txt) 或 README 中文簡介。

**資料庫路徑**：預設為 `D:\all_data\taiwan_stock_all_data.db`

---

## 更新記錄

### 2026-01-27
- 新增開發緣起、主要功能、產品特色、分析結果、未來發展五大章節於專案說明文件開頭
- 新增主選單選項 13–18 說明（融資融券、VIX 下載/月K線/衍生指標、中文 VIEW、技術指標、Orange Pipeline）
- 更新模組結構：data_collection（margin、vix_derivatives、technical_indicator、indicator、otc）、utils、VIX_dictionary_put_in_database、scripts
- 新增資料表說明：market_margin_data、TFE_VIX_data、VIX_data
- 專案說明文件開頭加入中英簡介與資料庫筆數統計連結（README）

### 2025-12-17
- 自動更新：檢測到關鍵檔案變更


### 2025-12-15
- 修正分批執行邏輯：從5天改為6天（5天正常執行 + 1天檢查剩餘現金）
- 修正買進/賣出金額計算：基於初始投資組合價值/初始持倉，而非當前價值
- 新增現金管理邏輯：現金不足買一張時保留作為預備金
- 新增第6天檢查：自動檢查並買進剩餘現金
- 新增Excel輸出格式：持倉欄位顯示ticker和平均成本，新增現金部位欄位
- 更新回測引擎為 BacktestEngineNew
- 移除所有調試日誌

### 2025-12-08
- 新增回測驗證檢查系統
- 新增本地語言模型專案說明文件
- 修正避險資產交易記錄的鍵名統一問題

### 2025-12-08
- 實作N+1月27日發布邏輯
- 修正信號時機判斷（從非藍燈→藍燈，從非紅燈→紅燈）
- 新增燈號年份、月份、分數到交易記錄

---

## 參考資料

- TEJ 台灣經濟新報：從景氣燈號到資產輪動：一套避開熊市的量化策略
- 證交所公開資料 API
- 櫃買中心公開資料 API
- 國發會景氣對策信號說明

---

**注意**：本文件會自動更新，請勿手動編輯。如需更新，請執行 `scripts/update_project_context.py`。

