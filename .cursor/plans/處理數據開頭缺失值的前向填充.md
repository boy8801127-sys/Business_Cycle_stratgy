# 處理數據開頭缺失值的前向填充

## 目標

為使用 `shift()` 和 `diff()` 產生的欄位添加前向填充（forward fill），確保數據完整，避免開頭出現 NaN 值。

## 現況分析

### 會產生開頭缺失值的欄位

1. **日線輸出** (`scripts/export_orange_data.py` 的 `export_orange_data_daily()`):
   - 融資融券指標的滯後值：`{col}_lag1`, `{col}_lag2` (第 531-532 行，使用 `shift(1)`, `shift(2)`)
   - 融資融券指標的變化量：`{col}_change` (第 533 行，使用 `diff()`)
   - 日報酬率：`daily_return` (第 552 行，使用 `pct_change()`)

2. **月線輸出** (`scripts/export_orange_data.py` 的 `export_orange_data_monthly()`):
   - 融資融券指標的滯後值：`{col}_lag1`, `{col}_lag2` (第 799-800 行，使用 `shift(1)`, `shift(2)`)
   - 融資融券指標的變化量：`{col}_change` (第 801 行，使用 `diff()`)

3. **預測數據輸出** (`orange_data_export/export_for_prediction.py` 的 `create_features()`):
   - 景氣分數滯後值：`score_lag1`, `score_lag2`, `score_lag3` (第 271-273 行，使用 `shift(1)`, `shift(2)`, `shift(3)`)
   - 景氣分數變化：`score_change`, `score_change_pct` (第 276-277 行，使用 `shift(1)`)

### 填充策略

- **前向填充（Forward Fill）**：使用每個 ticker 的第一個有效值填充開頭的 NaN
- **分組處理**：按 `ticker` 分組進行填充，確保不同股票的數據獨立處理
- **填充時機**：在計算完所有衍生欄位後，輸出 CSV 前進行填充

## 修改計劃

### 修改1：在日線輸出中添加前向填充 - 融資融券衍生指標

**檔案**：`scripts/export_orange_data.py`

**位置**：`export_orange_data_daily()` 函數，第 533 行後

**修改內容**：
在計算完融資融券衍生指標後，添加前向填充邏輯：

```python
# 前向填充融資融券衍生指標的缺失值（開頭數據）
print("  前向填充融資融券衍生指標的缺失值...")
lag_change_cols = [f'{col}_lag1' for col in margin_derived_cols if col in result_df.columns] + \
                  [f'{col}_lag2' for col in margin_derived_cols if col in result_df.columns] + \
                  [f'{col}_change' for col in margin_derived_cols if col in result_df.columns]
for col in lag_change_cols:
    if col in result_df.columns:
        result_df[col] = result_df.groupby('ticker')[col].ffill()
```

### 修改2：在日線輸出中添加前向填充 - 日報酬率

**檔案**：`scripts/export_orange_data.py`

**位置**：`export_orange_data_daily()` 函數，第 552 行後

**修改內容**：
在計算完日報酬率後，添加前向填充邏輯：

```python
# 前向填充日報酬率的缺失值（開頭數據）
result_df['daily_return'] = result_df.groupby('ticker')['daily_return'].ffill()
```

### 修改3：在月線輸出中添加前向填充

**檔案**：`scripts/export_orange_data.py`

**位置**：`export_orange_data_monthly()` 函數，第 801 行後

**修改內容**：
在計算完融資融券衍生指標後，添加前向填充邏輯：

```python
# 前向填充融資融券衍生指標的缺失值（開頭數據）
print("  前向填充融資融券衍生指標的缺失值...")
lag_change_cols = [f'{col}_lag1' for col in margin_derived_cols if col in out_df.columns] + \
                  [f'{col}_lag2' for col in margin_derived_cols if col in out_df.columns] + \
                  [f'{col}_change' for col in margin_derived_cols if col in out_df.columns]
for col in lag_change_cols:
    if col in out_df.columns:
        out_df[col] = out_df.groupby('ticker')[col].ffill()
```

### 修改4：在預測數據輸出中添加前向填充

**檔案**：`orange_data_export/export_for_prediction.py`

**位置**：`create_features()` 方法，第 277 行後

**修改內容**：
在計算完所有景氣燈號特徵後，添加前向填充邏輯：

```python
# 前向填充景氣燈號特徵的缺失值（開頭數據）
print("[Info] 前向填充景氣燈號特徵的缺失值...")
lag_cols = ['score_lag1', 'score_lag2', 'score_lag3', 'score_change', 'score_change_pct']
for col in lag_cols:
    if col in df.columns:
        # 如果有多個 ticker，按 ticker 分組填充；否則直接填充
        if 'ticker' in df.columns and df['ticker'].nunique() > 1:
            df[col] = df.groupby('ticker')[col].ffill()
        else:
            df[col] = df[col].ffill()
```

## 技術細節

### 前向填充實現方式

- **單一 ticker**：直接使用 `df['column'].ffill()`
- **多個 ticker**：使用 `df.groupby('ticker')['column'].ffill()` 確保不同股票的數據獨立填充

### 填充順序

1. 先計算所有衍生欄位（shift, diff, pct_change）
2. 然後統一進行前向填充
3. 確保按 ticker 分組，避免不同股票的數據互相影響

### 特殊處理

- **日報酬率**：第一筆數據的日報酬率原本為 NaN（因為沒有前一天的價格），填充後會使用該 ticker 的第一個有效日報酬率
- **變化量**：第一筆數據的變化量原本為 NaN，填充後會使用該 ticker 的第一個有效變化量
- **滯後值**：第一筆數據的滯後值原本為 NaN，填充後會使用該 ticker 的第一個有效滯後值

## 資料流程

```
計算衍生欄位（shift/diff/pct_change）
  ↓
產生開頭的 NaN 值
  ↓
前向填充（按 ticker 分組）
  ↓
數據完整，無開頭缺失值
  ↓
輸出 CSV
```

## 檔案修改清單

1. `scripts/export_orange_data.py`
   - 在 `export_orange_data_daily()` 中添加兩處前向填充（第 533 行後和第 552 行後）
   - 在 `export_orange_data_monthly()` 中添加前向填充（第 801 行後）

2. `orange_data_export/export_for_prediction.py`
   - 在 `create_features()` 方法中添加前向填充（第 277 行後）

## 驗證要點

修改後需要驗證：
1. 開頭的 NaN 值是否被正確填充
2. 不同 ticker 的數據是否獨立填充（不會互相影響）
3. 填充後的第一筆數據是否使用了該 ticker 的第一個有效值
4. 數據完整性是否提升（NaN 數量減少）
5. 輸出 CSV 的數據是否完整（無開頭缺失值）
